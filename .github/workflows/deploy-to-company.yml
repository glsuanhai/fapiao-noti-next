name: Deploy to Company Repository

on:
  # 当代码推送到main分支时触发
  push:
    branches:
      - main
  # 允许手动触发工作流
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 下载 Vercel 部署的静态网页
      - name: Download static website from Vercel
        run: |
          mkdir -p vercel-static
          cd vercel-static
          # 使用 wget 下载整个网站（递归爬取）
          wget -r -p -E -k -K https://fapiao-noti-next.vercel.app/ || true
          cd ..
          ls -la vercel-static/

      # 2. 配置 SSH 密钥用于推送代码到公司仓库
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.COMPANY_SSH_KEY }}

      # 3. 配置 Git 用户信息
      - name: Setup Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 4. 克隆公司仓库并推送构建结果
      - name: Clone company repository and push changes
        run: |
          # 克隆公司仓库
          git clone git@codeup.aliyun.com:61b7412cfa282c88e103944f/Web/official-web.git company-repo
          
          # 进入公司仓库目录
          cd company-repo
          
          # 创建或切换到 blog 分支
          git checkout -B blog
          
          # 清空 blog 目录并复制新的静态文件
          rm -rf blog/*
          mkdir -p blog
          
          # 从下载的 Vercel 网站中提取内容
          if [ -d "../vercel-static/fapiao-noti-next.vercel.app" ]; then
            cp -r ../vercel-static/fapiao-noti-next.vercel.app/* blog/
          else
            echo "未找到下载的网站文件"
            exit 1
          fi
          
          # 添加所有更改
          git add .
          
          # 提交更改
          git commit -m "Auto-deploy from Vercel - $(date)" || echo "No changes to commit"
          
          # 推送到公司仓库
          git push origin blog --force