name: Deploy to Company Repository

on:
  # 当代码推送到main分支时触发
  push:
    branches:
      - main
  # 允许手动触发工作流
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安装依赖
      - name: Install dependencies
        run: npm install

      # 4. 构建静态网站
      - name: Build static website
        run: |
          echo "Building static website..."
          npx next build
          npx next-sitemap --config next-sitemap.config.js
          node scripts/merge-sitemap.js
        env:
          # 静态导出模式
          EXPORT: true
          # Notion API 配置
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          NOTION_PAGE_ID: ${{ secrets.NOTION_PAGE_ID }}
          # 主题和语言配置
          NEXT_PUBLIC_THEME: ${{ secrets.NEXT_PUBLIC_THEME || 'simpleFeittt' }}
          NEXT_PUBLIC_LANG: ${{ secrets.NEXT_PUBLIC_LANG || 'zh-CN' }}

      # 5. 配置 SSH 密钥用于推送代码到公司仓库
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.COMPANY_SSH_KEY }}

      # 3. 配置 Git 用户信息
      - name: Setup Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 4. 添加公司仓库主机密钥
      - name: Add company repository host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H codeup.aliyun.com >> ~/.ssh/known_hosts 2>/dev/null || true

      # 5. 直接推送到公司仓库的 blog 目录
      - name: Push to company repository
        run: |
          # 配置临时git仓库
          mkdir -p /tmp/deploy
          cd /tmp/deploy
          
          # 初始化git仓库并设置远程
          git init
          git remote add origin git@codeup.aliyun.com:61b7412cfa282c88e103944f/Web/official-web.git
          
          # 拉取 master 分支现有内容
          git fetch origin master
          git checkout -b master origin/master
          
          # 备份现有的 blog 目录，添加时间戳
          if [ -d "blog" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            mv blog blog_backup_$TIMESTAMP
          fi
          
          # 新建 blog 目录并复制新文件
          mkdir -p blog
          cp -r $GITHUB_WORKSPACE/out/* blog/
          
          # 添加文件并提交
          git add .
          git commit -m "Auto-deploy from GitHub Actions - $(date)" || echo "No changes to commit"
          
          # 推送到 master 分支
          git push origin master
